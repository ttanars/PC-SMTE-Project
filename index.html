<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC | SMTE Projects</title>
    <link rel="shortcut icon" type="image/png" href="https://img2.pic.in.th/pic/Pakchong_School-removebg-preview.png">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.bootstrap5.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        :root {
            --primary-color: #0d6efd;
            --dark-bg: #212529;
            --light-bg: #f8f9fa;
            --sidebar-width: 280px;
        }
        body {
            display: flex;
            min-height: 100vh;
            font-family: 'Sarabun', sans-serif;
            background-color: var(--light-bg);
            overflow-x: hidden; /* Prevent horizontal scrollbar */
        }
        #sidebar {
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            background: var(--dark-bg);
            color: #fff;
            transition: margin-left 0.3s ease-in-out;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 1.25rem 1.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            border-bottom: 1px solid #343a40;
        }
        #sidebar .components { padding: 1rem; flex-grow: 1; }
        #sidebar ul li a {
            padding: 0.75rem 1rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            color: #adb5bd;
            text-decoration: none;
            transition: all 0.2s;
            border-radius: 0.375rem;
            margin-bottom: 0.25rem;
        }
        #sidebar ul li a:hover { color: #fff; background: #343a40; }
        #sidebar ul li a.active { color: #fff; background: var(--primary-color); font-weight: bold; }
        #sidebar ul li a .bi { margin-right: 0.75rem; font-size: 1.2rem; }
        .sidebar-footer { padding: 1rem; border-top: 1px solid #343a40; }
        #content {
            width: 100%;
            padding: 20px;
            transition: margin-left 0.3s ease-in-out;
            margin-left: var(--sidebar-width);
        }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .protected-link { display: none; } /* Hide protected links by default */
        .progress-container { display: flex; justify-content: space-between; align-items: flex-start; position: relative; width: 100%; margin-bottom: 20px; }
        .step { text-align: center; position: relative; z-index: 1; width: 12.5%; }
        .step-icon { width: 30px; height: 30px; border-radius: 50%; background-color: #fff; border: 2px solid #dee2e6; margin: 0 auto 10px auto; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .step-label { font-size: 0.8rem; color: #6c757d; }
        .step.active .step-icon, .step.completed .step-icon { background-color: var(--primary-color); border-color: var(--primary-color); color: white; }
        .step.completed .step-icon::before { font-family: 'bootstrap-icons'; content: '\F26E'; }
        .progress-container::before { content: ''; position: absolute; top: 15px; left: 6.25%; right: 6.25%; height: 2px; background-color: #dee2e6; z-index: 0; }
        #progress-line { position: absolute; top: 15px; left: 6.25%; height: 2px; background-color: var(--primary-color); z-index: 0; transition: width 0.4s ease; width: 0; }
        
        /* Table Header Style */
        .table > thead {
            background-color: var(--dark-bg);
            color: #fff;
        }

        /* Desktop Sidebar State */
        #sidebar.inactive {
            margin-left: calc(-1 * var(--sidebar-width));
        }
        #sidebar.inactive ~ #content {
            margin-left: 0;
        }

        /* Mobile Sidebar State */
        @media (max-width: 768px) {
            #sidebar {
                margin-left: calc(-1 * var(--sidebar-width));
            }
            #sidebar.active {
                margin-left: 0;
            }
            #content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <nav id="sidebar">
        <div>
            <div class="sidebar-header"><i class="fa-solid fa-star"></i> SMTE Projects</div>
            <ul class="list-unstyled components">
                <li><a href="#" class="nav-link active" data-target="home-content"><i class="bi bi-house-door"></i>หน้าหลัก</a></li>
                <li><a href="#" class="nav-link" data-target="project-list-content"><i class="bi bi-table"></i>รายการโครงงาน</a></li>
                <li><a href="#" class="nav-link protected-link" data-role="Teacher,ADMIN" data-target="review-content"><i class="bi bi-check2-square"></i>ตรวจโครงงาน</a></li>
                <li><a href="#" class="nav-link protected-link" data-role="ADMIN" data-target="admin-content"><i class="bi bi-person-gear"></i>สำหรับ ADMIN</a></li>
                <li><a href="#" class="nav-link protected-link" data-role="ADMIN" data-target="log-content"><i class="bi bi-clock-history"></i>ข้อมูลการใช้ระบบ</a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <div id="user-profile" class="d-none">
                <div class="text-white p-2 rounded bg-secondary mb-2">
                    <div><i class="bi bi-person-circle me-2"></i><span id="user-name-display"></span></div>
                    <div class="small"><i class="bi bi-shield-check me-2"></i>สิทธิ์: <span id="user-role-display"></span></div>
                </div>
                <button id="logout-btn" class="btn btn-danger w-100">ออกจากระบบ</button>
            </div>
            <button id="login-prompt-btn" class="btn btn-primary w-100"><i class="bi bi-box-arrow-in-right me-2"></i>เข้าสู่ระบบ</button>
        </div>
    </nav>

    <!-- Page Content -->
    <div id="content">
        <nav class="navbar navbar-expand-lg navbar-light bg-light rounded-3 shadow-sm mb-4">
            <div class="container-fluid">
                <!-- Mobile-only toggle button -->
                <button type="button" id="sidebarCollapse" class="btn btn-primary d-md-none"><i class="bi bi-list"></i></button>
                <h2 id="page-title" class="navbar-brand ms-3 mb-0" href="#" tabindex="-1">หน้าหลัก</h2>
            </div>
        </nav>

        <!-- Home Content -->
        <div id="home-content" class="content-section active">
            <div class="p-5 mb-4 bg-white rounded-3 shadow-sm">
                <div class="container-fluid py-5">
                    <h1 class="display-5 fw-bold">ยินดีต้อนรับสู่ระบบติดตามโครงงาน SMTE</h1>
                    <p class="col-md-8 fs-4">ระบบสำหรับติดตามความคืบหน้าและจัดการข้อมูลโครงงานของนักเรียนโครงการ SMTE</p>
                </div>
            </div>
        </div>

        <!-- Admin Content -->
        <div id="admin-content" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>จัดการรายการโครงงาน</h3>
                    <button id="add-project-row" class="btn btn-primary"><i class="bi bi-plus-circle me-2"></i>เพิ่มโครงงาน</button>
                </div>
                <div class="card-body">
                    <table id="admin-table" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>กลุ่มที่</th>
                                <th>ชื่อโครงงาน</th>
                                <th>ผู้จัดทำ</th>
                                <th>ครูที่ปรึกษา</th>
                                <th>ลิงค์เอกสาร</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="card-footer text-end">
                    <button id="save-data-btn" class="btn btn-success"><i class="bi bi-save me-2"></i>บันทึกข้อมูลทั้งหมดลง Sheet</button>
                </div>
            </div>
        </div>
        
        <!-- Project List Content -->
        <div id="project-list-content" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header"><h3>รายการโครงงานทั้งหมด</h3></div>
                <div class="card-body">
                    <table id="project-list-table" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
                        <thead>
                            <tr>
                                <th data-priority="3" class="text-center">กลุ่มที่</th>
                                <th data-priority="1">ชื่อโครงงาน</th>
                                <th data-priority="4">ผู้จัดทำ</th>
                                <th data-priority="5">ครูที่ปรึกษา</th>
                                <th data-priority="6" class="text-center">ลิงค์เอกสาร</th>
                                <th data-priority="2" class="text-center">ตรวจแล้ว</th>
                                <th data-priority="7">ผู้ตรวจ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Review Content -->
        <div id="review-content" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header"><h3>ตรวจความคืบหน้าโครงงาน</h3></div>
                <div class="card-body">
                    <table id="review-table" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
                        <thead>
                            <tr>
                                <th class="text-center">กลุ่มที่</th>
                                <th>ชื่อโครงงาน</th>
                                <th class="text-center">ลิงค์เอกสาร</th>
                                <th class="text-center">ตรวจแล้ว</th>
                                <th>เปลี่ยนสถานะ</th>
                                <th>ผู้ตรวจ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Log Content Section -->
        <div id="log-content" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header"><h3>ข้อมูลการใช้ระบบ (Log)</h3></div>
                <div class="card-body">
                    <table id="log-table" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>ชื่อ สกุลผู้บันทึก</th>
                                <th>การบันทึก</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Progress Modal -->
    <div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content"><div class="modal-header"><h5 class="modal-title">ความก้าวหน้าโครงงาน</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body pt-4"><div class="progress-container"></div></div></div>
      </div>
    </div>
    
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">เข้าสู่ระบบ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="mb-3"><label for="userInput" class="form-label">User</label><input type="text" class="form-control" id="userInput" required></div>
              <div class="mb-3"><label for="passInput" class="form-label">Pass</label><input type="password" class="form-control" id="passInput" required></div>
              <button type="submit" class="btn btn-primary w-100">เข้าสู่ระบบ</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>
    <script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.js"></script>
    <script src="https://cdn.datatables.net/responsive/3.0.2/js/responsive.bootstrap5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            // --- CONFIGURATION ---
            const webAppUrl = 'https://script.google.com/macros/s/AKfycbxoUkOMoIIE0w8ubn8GrUYo6MjVnKw28haD2bTLmapkuulnK8a9pApBtF0mDhoXPtqiMA/exec'; // <--- PASTE YOUR WEB APP URL HERE
            const progressSteps = ["ส่วนหน้า", "บท 1", "บท 2", "บท 3", "บท 4", "บท 5", "ส่วนท้าย", "Complete"];

            // --- GLOBAL STATE ---
            let projectData = [];
            let currentUser = null;
            let targetPageAfterAuth = null;

            // --- MODALS ---
            const loginModal = new bootstrap.Modal('#loginModal');
            const progressModal = new bootstrap.Modal('#progressModal');

            // --- DATATABLES ---
            const dtOptions = {
                responsive: true,
                language: { url: "https://cdn.datatables.net/plug-ins/2.0.8/i18n/th.json" }
            };
            const adminTable = $('#admin-table').DataTable({ ...dtOptions, paging: false, info: false, searching: false });
            const projectListTable = $('#project-list-table').DataTable({
                ...dtOptions,
                columnDefs: [
                    { className: "text-center", targets: [0, 4, 5] } // Center align: กลุ่มที่, ลิงค์เอกสาร, ตรวจแล้ว
                ]
            });
            const reviewTable = $('#review-table').DataTable({
                 ...dtOptions,
                columnDefs: [
                    { className: "text-center", targets: [0, 2, 3] } // Center align: กลุ่มที่, ลิงค์เอกสาร, ตรวจแล้ว
                ]
            });
            const logTable = $('#log-table').DataTable(dtOptions);


            // --- HELPER FUNCTIONS ---
            const showLoading = (title = 'กำลังโหลด...') => Swal.fire({ title: title, didOpen: () => Swal.showLoading(), allowOutsideClick: false });
            const createDynamicInput = (value = '', placeholder = 'เพิ่มชื่อ...') => `<div class="input-group dynamic-input-group mb-1"><input type="text" class="form-control" value="${value}" placeholder="${placeholder}"><button class="btn btn-outline-danger btn-sm remove-item-btn" type="button"><i class="bi bi-trash"></i></button></div>`;

            // --- SIDEBAR INTERACTIONS ---
            function setupSidebarInteractions() {
                // Unbind all namespaced events to avoid duplicates on resize
                $(document).off('.sidebar');
                $('#sidebar').off('.sidebar');
                $('#content').off('.sidebar');
                $('#sidebarCollapse').off('.sidebar');

                const $sidebar = $('#sidebar');

                if (window.innerWidth > 768) {
                    // --- DESKTOP: Hover-based logic ---
                    $sidebar.removeClass('active').addClass('inactive'); // Start hidden

                    $(document).on('mousemove.sidebar', function(e) {
                        // Show sidebar if mouse is at the left edge and it's hidden
                        if (e.clientX < 20 && $sidebar.hasClass('inactive')) {
                            $sidebar.removeClass('inactive');
                        }
                    });

                    // Hide sidebar when the mouse leaves it
                    $sidebar.on('mouseleave.sidebar', function() {
                        $sidebar.addClass('inactive');
                    });
                } else {
                    // --- MOBILE: Click-based logic ---
                    $sidebar.removeClass('inactive'); // Ensure it's not hidden by desktop styles

                    $('#sidebarCollapse').on('click.sidebar', function(e) {
                        e.stopPropagation(); // Prevent content click from firing
                        $sidebar.toggleClass('active');
                    });

                    // Hide sidebar when clicking on the main content area
                    $('#content').on('click.sidebar', function() {
                        if ($sidebar.hasClass('active')) {
                            $sidebar.removeClass('active');
                        }
                    });
                }
            }


            // --- DATA FETCH & RENDER FUNCTIONS ---
            function fetchInitialData() {
                showLoading('กำลังดึงข้อมูลโครงงาน...');
                fetch(`${webAppUrl}?action=getProjects`)
                    .then(res => res.json())
                    .then(response => {
                        if (response.status === 'success') {
                            projectData = response.data.map(p => ({
                                ...p,
                                status: p['สถานะ'] || 'ส่วนหน้า',
                                group: p['กลุ่มที่'],
                                name: p['ชื่อโครงงาน'],
                                authors: p['ผู้จัดทำ'] || [],
                                advisors: p['ครูที่ปรึกษา'] || [],
                                link: p['ลิงค์เอกสาร'],
                                recorder: p['ผู้บันทึก']
                            }));
                            renderAllTables();
                            Swal.close();
                        } else {
                            throw new Error(response.message);
                        }
                    })
                    .catch(error => Swal.fire('เกิดข้อผิดพลาด', error.message, 'error'));
            }

            function fetchAndRenderLogs() {
                showLoading('กำลังโหลดข้อมูลการใช้งาน...');
                fetch(`${webAppUrl}?action=getLogs`)
                    .then(res => res.json())
                    .then(response => {
                        if (response.status === 'success') {
                            logTable.clear();
                            response.data.forEach(log => {
                                // Corrected property name from 'timestamp' to 'Timestamp' to match the sheet header
                                const dateObj = new Date(log.Timestamp);
                                const timestamp = !isNaN(dateObj) 
                                    ? dateObj.toLocaleString('th-TH', {
                                        year: 'numeric', month: 'short', day: 'numeric',
                                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                                    })
                                    : 'Invalid Date';

                                logTable.row.add([
                                    timestamp,
                                    log['ชื่อ สกุลผู้บันทึก'],
                                    log['การบันทึก']
                                ]);
                            });
                            logTable.order([0, 'desc']).draw(); // Sort by timestamp descending
                            Swal.close();
                        } else {
                            throw new Error(response.message);
                        }
                    })
                    .catch(error => Swal.fire('เกิดข้อผิดพลาด', error.message, 'error'));
            }

            function renderAllTables() {
                renderAdminTable();
                renderProjectListTable();
                renderReviewTable();
                // Adjust columns after rendering, especially for hidden tables
                $($.fn.dataTable.tables(true)).DataTable().columns.adjust().responsive.recalc();
            }

            function renderAdminTable() {
                adminTable.clear();
                projectData.forEach((data, index) => {
                    const authorsHtml = (data.authors.length > 0 ? data.authors.map(a => createDynamicInput(a)).join('') : createDynamicInput(''));
                    const advisorsHtml = (data.advisors.length > 0 ? data.advisors.map(a => createDynamicInput(a)).join('') : createDynamicInput(''));
                    adminTable.row.add([
                        `<input type="number" class="form-control" value="${data.group || ''}" data-row-index="${index}">`,
                        `<input type="text" class="form-control" value="${data.name || ''}">`,
                        `<div class="dynamic-container">${authorsHtml}</div><button class="btn btn-outline-success btn-sm add-item-btn mt-1" type="button"><i class="bi bi-plus"></i> เพิ่มผู้จัดทำ</button>`,
                        `<div class="dynamic-container">${advisorsHtml}</div><button class="btn btn-outline-success btn-sm add-item-btn mt-1" type="button"><i class="bi bi-plus"></i> เพิ่มที่ปรึกษา</button>`,
                        `<input type="url" class="form-control" value="${data.link || ''}" placeholder="https://...">`,
                        `<button class="btn btn-danger remove-row-btn" data-row-index="${index}"><i class="bi bi-x-circle"></i> ลบแถว</button>`
                    ]);
                });
                adminTable.draw(false);
            }

            function renderProjectListTable() {
                projectListTable.clear();
                projectData.forEach((proj, index) => {
                    const authorsList = proj.authors.join('<br>');
                    const advisorsList = proj.advisors.join('<br>');
                    const docLink = proj.link ? `<a href="${proj.link}" target="_blank" class="btn btn-sm btn-info">เปิดลิงค์</a>` : 'ไม่มี';
                    const statusBtn = `<button class="btn btn-sm btn-secondary view-status-btn" data-project-index="${index}">${proj.status}</button>`;
                    projectListTable.row.add([proj.group, proj.name, authorsList, advisorsList, docLink, statusBtn, proj.recorder || '-']);
                });
                projectListTable.draw();
            }

            function renderReviewTable() {
                reviewTable.clear();
                projectData.forEach((proj, index) => {
                    const docLink = proj.link ? `<a href="${proj.link}" target="_blank" class="btn btn-sm btn-info">เปิดลิงค์</a>` : 'ไม่มี';
                    const statusOptions = progressSteps.map(step => `<option value="${step}" ${proj.status === step ? 'selected' : ''}>${step}</option>`).join('');
                    const statusSelect = `<select class="form-select review-status-select" data-project-group="${proj.group}">${statusOptions}</select>`;
                    reviewTable.row.add([proj.group, proj.name, docLink, proj.status, statusSelect, proj.recorder || '-']);
                });
                reviewTable.draw();
            }

            // --- UI & NAVIGATION ---
            function updateUIAfterLogin() {
                if (currentUser) {
                    $('#login-prompt-btn').addClass('d-none');
                    $('#user-profile').removeClass('d-none');
                    $('#user-name-display').text(currentUser.name);
                    $('#user-role-display').text(currentUser.role);
                    $('.protected-link').each(function() {
                        const requiredRoles = $(this).data('role').split(',');
                        if (requiredRoles.includes(currentUser.role)) {
                            $(this).show();
                        }
                    });
                } else {
                    $('#login-prompt-btn').removeClass('d-none');
                    $('#user-profile').addClass('d-none');
                    $('.protected-link').hide();
                    switchToPage($('.nav-link[data-target="home-content"]'));
                }
            }

            function switchToPage(linkElement) {
                const targetId = linkElement.data('target');
                if (!targetId) return;
                $('.nav-link').removeClass('active');
                linkElement.addClass('active');
                $('#page-title').text(linkElement.text().trim());
                $('.content-section').removeClass('active');
                $('#' + targetId).addClass('active');
                
                if (targetId === 'log-content') {
                    fetchAndRenderLogs();
                }

                $($.fn.dataTable.tables(true)).DataTable().columns.adjust().responsive.recalc();
                // On mobile, hide sidebar after clicking a link
                if (window.innerWidth <= 768 && $('#sidebar').hasClass('active')) {
                    $('#sidebar').removeClass('active');
                }
                $('#page-title').focus();
            }

            // --- EVENT HANDLERS ---
            $('.nav-link').on('click', function(e) {
                e.preventDefault();
                if ($(this).hasClass('protected-link')) {
                    if (currentUser) {
                        switchToPage($(this));
                    } else {
                        targetPageAfterAuth = $(this).data('target');
                        loginModal.show();
                    }
                } else {
                    switchToPage($(this));
                }
            });
            
            $('#login-prompt-btn').on('click', () => loginModal.show());

            $('#logout-btn').on('click', () => {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                updateUIAfterLogin();
                Swal.fire({ icon: 'success', title: 'ออกจากระบบสำเร็จ', timer: 1500, showConfirmButton: false });
            });

            $('#loginForm').on('submit', function(e) {
                e.preventDefault();
                showLoading('กำลังเข้าสู่ระบบ...');
                const payload = {
                    action: 'login',
                    user: $('#userInput').val(),
                    pass: $('#passInput').val()
                };
                fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                })
                .then(res => res.json())
                .then(response => {
                    if (response.status === 'success' && response.data.name) {
                        currentUser = response.data;
                        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                        loginModal.hide();
                        Swal.close();
                        updateUIAfterLogin();
                        if (targetPageAfterAuth) {
                            switchToPage($(`.nav-link[data-target="${targetPageAfterAuth}"]`));
                            targetPageAfterAuth = null;
                        }
                    } else {
                        throw new Error(response.message || 'ข้อมูลเข้าระบบไม่ถูกต้อง');
                    }
                })
                .catch(error => Swal.fire('Login ไม่สำเร็จ', error.message, 'error'));
            });

            $('#add-project-row').on('click', () => {
                 projectData.push({ group: "", name: "", authors: [], advisors: [], link: "", status: progressSteps[0], recorder: "" });
                 renderAdminTable();
            });

            $('#admin-table tbody').on('click', '.remove-row-btn', function () {
                const index = $(this).data('row-index');
                projectData.splice(index, 1);
                renderAdminTable();
            });

            $('#admin-table tbody').on('click', '.add-item-btn', function () { $(this).prev('.dynamic-container').append(createDynamicInput()); });
            $('#admin-table tbody').on('click', '.remove-item-btn', function () { $(this).closest('.dynamic-input-group').remove(); });
            
            $('#save-data-btn').on('click', function() {
                showLoading('กำลังบันทึกข้อมูล...');
                const updatedData = [];
                adminTable.rows().every(function() {
                    const rowNode = this.node();
                    const authors = Array.from($(rowNode).find('td:eq(2) input')).map(el => el.value).filter(Boolean);
                    const advisors = Array.from($(rowNode).find('td:eq(3) input')).map(el => el.value).filter(Boolean);
                    updatedData.push({
                        group: $(rowNode).find('td:eq(0) input').val(),
                        name: $(rowNode).find('td:eq(1) input').val(),
                        authors: authors,
                        advisors: advisors,
                        link: $(rowNode).find('td:eq(4) input').val(),
                    });
                });
                
                const payload = {
                    action: 'saveAllProjects',
                    data: updatedData,
                    recorder: currentUser ? currentUser.name : 'System'
                };

                fetch(webAppUrl, { 
                    method: 'POST', 
                    body: JSON.stringify(payload) 
                })
                .then(res => res.json())
                .then(response => {
                    if (response.status === 'success') {
                        Swal.fire('สำเร็จ', 'บันทึกข้อมูลทั้งหมดเรียบร้อยแล้ว', 'success');
                        fetchInitialData(); // Refresh data from sheet
                    } else {
                        throw new Error(response.message);
                    }
                })
                .catch(error => Swal.fire('เกิดข้อผิดพลาด', error.message, 'error'));
            });
            
            $('#review-table tbody').on('change', '.review-status-select', function() {
                // Check if user is logged in before proceeding
                if (!currentUser) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ไม่ได้เข้าสู่ระบบ',
                        text: 'กรุณาเข้าสู่ระบบก่อนทำการเปลี่ยนแปลงสถานะ',
                    });
                    // Revert the change in the dropdown
                    const projectGroup = $(this).data('project-group').toString();
                    const originalStatus = projectData.find(p => p.group.toString() === projectGroup).status;
                    $(this).val(originalStatus);
                    return;
                }

                const newStatus = $(this).val();
                const projectGroup = $(this).data('project-group');
                
                showLoading('กำลังอัปเดตสถานะ...');
                const payload = {
                    action: 'updateStatus',
                    group: projectGroup,
                    newStatus: newStatus,
                    recorder: currentUser.name
                };

                fetch(webAppUrl, { 
                    method: 'POST', 
                    body: JSON.stringify(payload) 
                })
                .then(res => res.json())
                .then(response => {
                    if (response.status === 'success') {
                        Swal.fire({ icon: 'success', title: 'อัปเดตสถานะสำเร็จ', timer: 1500, showConfirmButton: false });
                        // Update local data for immediate UI feedback
                        const projIndex = projectData.findIndex(p => p.group.toString() === projectGroup.toString());
                        if (projIndex > -1) {
                            projectData[projIndex].status = newStatus;
                            projectData[projIndex].recorder = currentUser.name;
                            renderAllTables();
                        }
                    } else {
                        throw new Error(response.message);
                    }
                })
                .catch(error => {
                    Swal.fire('เกิดข้อผิดพลาด', error.message, 'error');
                    fetchInitialData(); // Revert changes by fetching fresh data
                });
            });

            $('#project-list-table tbody').on('click', '.view-status-btn', function () {
                const projectIndex = $(this).data('project-index');
                const project = projectData[projectIndex];
                const statusIndex = progressSteps.indexOf(project.status);
                const modalBody = $('#progressModal .progress-container');
                
                let stepsHtml = progressSteps.map(label => `<div class="step"><div class="step-icon"></div><div class="step-label">${label}</div></div>`).join('');
                modalBody.html('<div id="progress-line"></div>' + stepsHtml);
                
                modalBody.find('.step').each((index, el) => {
                    if (index < statusIndex) $(el).addClass('completed');
                    else if (index === statusIndex) $(el).addClass('active');
                });
                
                const adjustedWidth = statusIndex > 0 ? (statusIndex / (progressSteps.length - 1)) * (100 - (100 / progressSteps.length)) : 0;
                modalBody.find('#progress-line').css('width', `${adjustedWidth}%`);
                
                progressModal.show();
            });

            // --- INITIALIZATION ---
            setupSidebarInteractions();
            $(window).on('resize', setupSidebarInteractions);

            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
            }
            updateUIAfterLogin();
            fetchInitialData();
        });
    </script>
</body>
</html>
